name: Publish to AUR

on:
  push:
    tags:
      - "v*"
      - "sea-lantern-v*"
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: "Version to publish (e.g., 1.0.0)"
        required: true
        type: string
      skip_test:
        description: "Skip makepkg test"
        required: false
        default: false
        type: boolean

jobs:
  aur-publish:
    # ‰ΩøÁî® Arch Linux ÂÆπÂô®Áõ¥Êé•ËøêË°åÔºåÈÅøÂÖçÂµåÂ•ó Docker
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
      options: --user root

    steps:
      - name: Install dependencies in container
        run: |
          # ÂàùÂßãÂåñ pacman ÂØÜÈí•ÁéØ
          pacman-key --init
          pacman-key --populate archlinux

          # Á≥ªÁªüÊõ¥Êñ∞Âπ∂ÂÆâË£ÖÂøÖË¶ÅÂ∑•ÂÖ∑

          pacman -Syu --noconfirm base-devel git sudo openssh dpkg

          # ÂàõÂª∫ builder Áî®Êà∑
          useradd -m builder
          echo 'builder ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Debug GitHub context
        run: |
          echo "GitHub Context Debug:"
          echo "Event name: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"
          echo "Ref type: ${{ github.ref_type }}"
          echo "Ref name: ${{ github.ref_name }}"
          echo "Release tag: ${{ github.event.release.tag_name }}"
          echo "Repository: ${{ github.repository }}"
          echo "Actor: ${{ github.actor }}"

      - name: Get release version
        id: get_version
        run: |
          # Ê†πÊçÆ‰∫ã‰ª∂Á±ªÂûãËé∑ÂèñÁâàÊú¨
          if [[ "${{ github.event_name }}" == "release" ]]; then
            RAW_VERSION="${{ github.event.release.tag_name }}"
            echo "Source: release tag: $RAW_VERSION"
          elif [[ "${{ github.event_name }}" == "push" ]]; then
            RAW_VERSION="${{ github.ref_name }}"
            echo "Source: git tag: $RAW_VERSION"
          else
            RAW_VERSION="${{ github.event.inputs.version }}"
            echo "Source: manual input: $RAW_VERSION"
          fi

          # ÊèêÂèñÁ∫ØÂáÄÁâàÊú¨Âè∑
          if [[ $RAW_VERSION =~ [0-9]+\.[0-9]+\.[0-9]+ ]]; then
            VERSION=$(echo "$RAW_VERSION" | grep -oE '[0-9]+\.[0-9]+\.[0-9]+')
            echo "Extracted version from tag: $VERSION"
          else
            VERSION="${RAW_VERSION#v}"
          fi

          # È™åËØÅÁâàÊú¨Âè∑
          if [[ -z "$VERSION" ]]; then
            echo "‚ùå Error: Version is empty!"
            exit 1
          fi

          if ! [[ $VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "‚ùå Error: Invalid version format: $VERSION"
            exit 1
          fi

          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_ENV
          echo "‚úÖ Final version: $VERSION"

      - name: Validate PKGBUILD exists
        run: |
          if [ ! -f "PKGBUILD" ]; then
            echo "Error: PKGBUILD file not found!"
            ls -la
            exit 1
          fi
          echo "‚úÖ PKGBUILD found"

      - name: Update PKGBUILD version
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          echo "Updating PKGBUILD to version: $VERSION"

          # Â§á‰ªΩÂéüÂßã PKGBUILD
          cp PKGBUILD PKGBUILD.bak

          # Êõ¥Êñ∞ÁâàÊú¨Âè∑
          sed -i "s/^pkgver=.*/pkgver=${VERSION}/" PKGBUILD
          sed -i "s/^pkgrel=.*/pkgrel=1/" PKGBUILD

          echo "‚úÖ Updated PKGBUILD"
          echo "New version: $(grep ^pkgver= PKGBUILD)"

      - name: Generate .SRCINFO
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          echo "Generating .SRCINFO for version: $VERSION"

          # ‰ΩøÁî® builder Áî®Êà∑ËøêË°å makepkg
          chown -R builder:builder .
          sudo -u builder makepkg --printsrcinfo > .SRCINFO

          if [ ! -f ".SRCINFO" ]; then
            echo "‚ùå Failed to generate .SRCINFO"
            exit 1
          fi

          echo "‚úÖ Generated .SRCINFO:"
          cat .SRCINFO

      - name: Validate files
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"

          # È™åËØÅ PKGBUILD
          PKGVER=$(grep "^pkgver=" PKGBUILD | cut -d= -f2 | xargs)
          if [[ "$PKGVER" != "$VERSION" ]]; then
            echo "‚ùå PKGBUILD version mismatch!"
            exit 1
          fi
          echo "‚úÖ PKGBUILD version matches: $PKGVER"

          # È™åËØÅ .SRCINFO
          SRCINFO_VER=$(grep "^[[:space:]]*pkgver =" .SRCINFO | head -1 | awk '{print $3}')
          if [[ "$SRCINFO_VER" != "$VERSION" ]]; then
            echo "‚ùå .SRCINFO version mismatch!"
            exit 1
          fi
          echo "‚úÖ .SRCINFO version matches: $SRCINFO_VER"

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.AUR_SSH_PRIVATE_KEY }}" > ~/.ssh/aur
          chmod 600 ~/.ssh/aur

          # ÈÖçÁΩÆ SSH
          cat > ~/.ssh/config << EOF
          Host aur.archlinux.org
            IdentityFile ~/.ssh/aur
            User aur
            StrictHostKeyChecking accept-new
          EOF

          # Ê∑ªÂä† known hosts
          ssh-keyscan -H aur.archlinux.org >> ~/.ssh/known_hosts

      - name: Publish AUR package
        uses: KSXGitHub/github-actions-deploy-aur@v3.0.1
        with:
          pkgname: sealantern
          pkgbuild: PKGBUILD
          assets: |
            .SRCINFO
            sealantern.install
          commit_username: "${{ github.actor }}"
          commit_email: "${{ github.actor }}@users.noreply.github.com"
          ssh_private_key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
          commit_message: "Update sealantern to v${{ steps.get_version.outputs.VERSION }}"
          allow_empty_commits: false
          force_push: false
          updpkgsums: false
          test: ${{ !github.event.inputs.skip_test }}
          ssh_keyscan_types: rsa,ecdsa,ed25519

      - name: Send success notification
        if: success()
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          echo "======================================"
          echo "‚úÖ Successfully published sealantern v${VERSION} to AUR"
          echo "üì¶ Package URL: https://aur.archlinux.org/packages/sealantern"
          echo "======================================"

      - name: Send failure notification
        if: failure()
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          echo "======================================"
          echo "‚ùå Failed to publish sealantern v${VERSION} to AUR"
          echo "======================================"

      - name: Cleanup
        if: always()
        run: |
          if [ -f "PKGBUILD.bak" ]; then
            echo "Restoring original PKGBUILD"
            rm -f PKGBUILD
            mv PKGBUILD.bak PKGBUILD
            echo "‚úÖ PKGBUILD restored"
          else
            echo "No backup file found, skipping cleanup"
          fi
